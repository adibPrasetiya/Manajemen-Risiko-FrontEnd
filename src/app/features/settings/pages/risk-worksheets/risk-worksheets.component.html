<div class="worksheets-page">
  <div class="action-row top">
    <div class="page-title">
      <div class="title-main">Risk Worksheet</div>
      <div class="title-sub muted" *ngIf="unitKerjaName">
        {{ unitKerjaName }} <span *ngIf="unitKerjaCode">({{ unitKerjaCode }})</span>
      </div>
    </div>

    <button class="btn primary" type="button" (click)="openCreate()">
      <i class="fa-solid fa-plus"></i>
      Tambah Risk Worksheet
    </button>
  </div>

  <div class="stats-row">
    <div class="stat-card">
      <div class="stat-icon">
        <i class="fa-solid fa-clipboard-list"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ totalWorksheets }}</div>
        <div class="stat-label">Total Worksheet</div>
      </div>
    </div>

    <div class="stat-card stat-active">
      <div class="stat-icon">
        <i class="fa-solid fa-circle-check"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ totalActive }}</div>
        <div class="stat-label">Active</div>
      </div>
    </div>

    <div class="stat-card stat-inactive">
      <div class="stat-icon">
        <i class="fa-solid fa-circle-xmark"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ totalInactive }}</div>
        <div class="stat-label">Inactive</div>
      </div>
    </div>

    <div class="stat-card stat-archived">
      <div class="stat-icon">
        <i class="fa-solid fa-box-archive"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ totalArchived }}</div>
        <div class="stat-label">Archived</div>
      </div>
    </div>
  </div>

  <div class="card">
    <div class="card-head">
      <div class="head-left">
        <span class="head-ico"><i class="fa-solid fa-clipboard-list"></i></span>
        <span class="head-title">Daftar Risk Worksheet</span>
      </div>

      <div class="filters-primary">
        <div class="search-group">
          <div class="search-field">
            <i class="fa-solid fa-magnifying-glass search-icon"></i>
            <input
              [(ngModel)]="q"
              placeholder="Cari nama / konteks..."
              (keyup.enter)="applySearch()"
            />
          </div>
          <div class="search-field">
            <i class="fa-solid fa-circle-dot search-icon"></i>
            <select [(ngModel)]="fStatus" (ngModelChange)="applySearch()">
              <option value="ALL">All Status</option>
              <option value="ACTIVE">Active</option>
              <option value="INACTIVE">Inactive</option>
              <option value="ARCHIVED">Archived</option>
            </select>
          </div>
        </div>

        <div class="filter-actions">
          <button class="btn primary" type="button" (click)="applySearch()" [disabled]="loading">
            <i class="fa-solid fa-magnifying-glass"></i>
            Search
          </button>
          <button class="btn" type="button" (click)="resetSearch()" [disabled]="loading">
            <i class="fa-solid fa-rotate-right"></i>
            Reset
          </button>
        </div>
      </div>
    </div>

    <div class="hint" *ngIf="loading">Loading...</div>
    <div class="hint warn" *ngIf="errorMsg">{{ errorMsg }}</div>

    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>NAMA</th>
            <th>KONTEKS</th>
            <th>DESKRIPSI</th>
            <th>STATUS</th>
            <th>CREATED AT</th>
            <th class="th-actions">ACTIONS</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let item of items">
            <td>
              <div class="cell-stack">
                <div class="primary">{{ item.name }}</div>
                <div class="sub muted" *ngIf="item.konteks?.code">
                  {{ item.konteks?.code }}
                </div>
              </div>
            </td>

            <td class="muted">{{ item.konteks?.name || '-' }}</td>

            <td class="muted">{{ item.description || '-' }}</td>

            <td>
              <span class="badge" [ngClass]="getStatusClass(item.status)">
                {{ getStatusLabel(item.status) }}
              </span>
            </td>

            <td class="muted">{{ item.createdAt | date: 'd MMM y, HH.mm' }}</td>

            <td class="td-actions">
              <button type="button" class="icon-btn" (click)="openEdit(item)" title="Edit">
                <i class="fa-solid fa-pen-to-square"></i>
              </button>

              <button
                *ngIf="item.status === 'ACTIVE'"
                type="button"
                class="icon-btn"
                (click)="setInactive(item)"
                title="Nonaktifkan"
              >
                <i class="fa-solid fa-toggle-off"></i>
              </button>

              <button
                *ngIf="item.status === 'INACTIVE'"
                type="button"
                class="icon-btn"
                (click)="setActive(item)"
                title="Aktifkan"
              >
                <i class="fa-solid fa-toggle-on"></i>
              </button>

              <button
                type="button"
                class="icon-btn danger"
                (click)="openDelete(item)"
                [disabled]="item.status === 'ARCHIVED'"
                title="Arsipkan"
              >
                <i class="fa-solid fa-trash-can"></i>
              </button>
            </td>
          </tr>

          <tr *ngIf="!loading && items.length === 0">
            <td colspan="6" class="empty">Data risk worksheet tidak ditemukan.</td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="pagination" *ngIf="pagination && pagination.totalPages > 0">
      <div class="pagination-info">
        <span class="showing-text">
          Showing <strong>{{ getShowingStart() }}</strong> - <strong>{{ getShowingEnd() }}</strong>
          of <strong>{{ pagination.totalItems }}</strong> data
        </span>
      </div>

      <div class="pagination-controls">
        <div class="per-page">
          <label>Rows:</label>
          <select [(ngModel)]="limit" (ngModelChange)="onLimitChange()">
            <option *ngFor="let opt of limitOptions" [value]="opt">{{ opt }}</option>
          </select>
        </div>

        <div class="page-nav">
          <button
            class="nav-btn"
            type="button"
            (click)="prevPage()"
            [disabled]="loading || !pagination.hasPrevPage"
            title="Previous page"
          >
            <i class="fa-solid fa-chevron-left"></i>
          </button>

          <div class="page-numbers">
            <ng-container *ngFor="let p of getPageNumbers()">
              <span class="ellipsis" *ngIf="p === -1">...</span>
              <button
                *ngIf="p !== -1"
                class="page-btn"
                type="button"
                [class.active]="p === pagination.page"
                (click)="goToPage(p)"
                [disabled]="loading"
              >
                {{ p }}
              </button>
            </ng-container>
          </div>

          <button
            class="nav-btn"
            type="button"
            (click)="nextPage()"
            [disabled]="loading || !pagination.hasNextPage"
            title="Next page"
          >
            <i class="fa-solid fa-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- ===================== MODAL: CREATE ===================== -->
<div class="modal-backdrop" *ngIf="showCreateModal">
  <div class="modal">
    <div class="modal-head">
      <h3>Tambah Risk Worksheet</h3>
      <button type="button" class="icon-close" (click)="closeCreate()">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>

    <div class="modal-body">
      <div class="field">
        <label>Konteks</label>
        <select [(ngModel)]="createModel.konteksId" name="createKonteks">
          <option value="">Pilih konteks</option>
          <option *ngFor="let k of konteksOptions" [value]="k.id">
            {{ k.name }} ({{ k.code }})
          </option>
        </select>
        <small class="error" *ngIf="createErrors.konteksId">{{ createErrors.konteksId }}</small>
      </div>

      <div class="grid-2">
        <div class="field">
          <label>Nama</label>
          <input [(ngModel)]="createModel.name" name="createName" />
          <small class="error" *ngIf="createErrors.name">{{ createErrors.name }}</small>
        </div>

        <div class="field">
          <label>Status</label>
          <select [(ngModel)]="createModel.status" name="createStatus">
            <option value="ACTIVE">Active</option>
            <option value="INACTIVE">Inactive</option>
          </select>
        </div>
      </div>

      <div class="field">
        <label>Deskripsi</label>
        <textarea [(ngModel)]="createModel.description" name="createDescription"></textarea>
        <small class="error" *ngIf="createErrors.description">{{ createErrors.description }}</small>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn secondary" (click)="closeCreate()" [disabled]="loading">
          Batal
        </button>
        <button type="button" class="btn primary" (click)="createWorksheet()" [disabled]="loading">
          Simpan
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ===================== MODAL: EDIT ===================== -->
<div class="modal-backdrop" *ngIf="showEditModal">
  <div class="modal">
    <div class="modal-head">
      <h3>Ubah Risk Worksheet</h3>
      <button type="button" class="icon-close" (click)="closeEdit()">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>

    <div class="modal-body">
      <div class="field">
        <label>Konteks</label>
        <input [value]="editModel.konteksLabel" disabled />
      </div>

      <div class="grid-2 spaced">
        <div class="field">
          <label>Nama</label>
          <input [(ngModel)]="editModel.name" name="editName" />
          <small class="error" *ngIf="editErrors.name">{{ editErrors.name }}</small>
        </div>

        <div class="field">
          <label>Status</label>
          <input [value]="getStatusLabel(editModel.status)" disabled />
        </div>
      </div>

      <div class="field">
        <label>Deskripsi</label>
        <textarea [(ngModel)]="editModel.description" name="editDescription"></textarea>
        <small class="error" *ngIf="editErrors.description">{{ editErrors.description }}</small>
      </div>

      <div class="modal-actions">
        <button type="button" class="btn secondary" (click)="closeEdit()" [disabled]="loading">
          Batal
        </button>
        <button type="button" class="btn primary" (click)="saveEdit()" [disabled]="loading">
          Simpan
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ===================== MODAL: DELETE ===================== -->
<div class="modal-backdrop" *ngIf="showDeleteModal">
  <div class="modal">
    <div class="modal-head">
      <h3>Arsipkan Risk Worksheet</h3>
      <button type="button" class="icon-close" (click)="closeDelete()">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>

    <div class="modal-body">
      <p class="confirm">
        Yakin ingin mengarsipkan:
        <b>{{ deleteTarget?.name }}</b> ?
      </p>

      <small class="error" *ngIf="deleteError">{{ deleteError }}</small>

      <div class="modal-actions">
        <button type="button" class="btn secondary" (click)="closeDelete()" [disabled]="loading">
          Batal
        </button>
        <button type="button" class="btn danger" (click)="confirmDelete()" [disabled]="loading">
          Arsipkan
        </button>
      </div>
    </div>
  </div>
</div>
