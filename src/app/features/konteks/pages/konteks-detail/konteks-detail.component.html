<div class="konteks-detail-page">
  <!-- HEADER -->
  <div class="card">
    <div class="card-head">
      <div class="head-left">
        <span class="head-ico"><i class="fa-solid fa-file-lines"></i></span>
        <div class="head-stack">
          <div class="head-title">
            {{ konteksName || 'Detail Konteks' }}
            <span class="code" *ngIf="konteksCode"> {{ konteksCode }}</span>
          </div>
          <div class="head-sub muted">Pengelolaan detail konteks risiko.</div>
        </div>
      </div>

      <div class="head-actions">
        <button
          *ngIf="konteksDetail && !konteksDetail.isActive"
          class="btn btn-activate"
          type="button"
          (click)="activateKonteks()"
          [disabled]="loading">
          <i class="fa-solid fa-toggle-on"></i> Aktifkan
        </button>
        <button
          *ngIf="konteksDetail && konteksDetail.isActive"
          class="btn btn-deactivate"
          type="button"
          (click)="deactivateKonteks()"
          [disabled]="loading">
          <i class="fa-solid fa-toggle-off"></i> Nonaktifkan
        </button>
        <button class="btn primary" type="button" (click)="openEditKonteks()" [disabled]="loading">
          <i class="fa-solid fa-pen-to-square"></i> Edit Konteks
        </button>
        <button class="btn secondary" type="button" (click)="back()">
          <i class="fa-solid fa-arrow-left"></i> Back
        </button>
      </div>
    </div>
  </div>

  <!-- KONTEKS INFO CARD -->
  <div class="card konteks-info-card" *ngIf="konteksDetail">
    <div class="card-body">
      <div class="info-grid">
        <!-- Basic Info -->
        <div class="info-section">
          <div class="section-label">Informasi Dasar</div>
          <div class="info-row">
            <span class="info-label">Nama:</span>
            <span class="info-value">{{ konteksDetail.name || '-' }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Kode:</span>
            <span class="info-value mono">{{ konteksDetail.code || '-' }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Deskripsi:</span>
            <span class="info-value long-text">{{ konteksDetail.description || '-' }}</span>
          </div>
        </div>

        <!-- Period & Matrix -->
        <div class="info-section">
          <div class="section-label">Periode & Matrix</div>
          <div class="info-row">
            <span class="info-label">Periode:</span>
            <span class="info-value">{{ konteksDetail.periodStart }} - {{ konteksDetail.periodEnd }}</span>
          </div>
          <div class="info-row">
            <span class="info-label">Matrix Size:</span>
            <span class="info-value">{{ konteksDetail.matrixSize ? konteksDetail.matrixSize + 'x' + konteksDetail.matrixSize : '-' }}</span>
          </div>
        </div>

        <!-- Risk Appetite -->
        <div class="info-section">
          <div class="section-label">Risk Appetite</div>
          <div class="info-row">
            <span class="info-label">Level:</span>
            <span class="info-value">
              <span class="appetite-badge" [ngClass]="getRiskAppetiteBadgeClass()">
                {{ konteksDetail.riskAppetiteLevel || '-' }}
              </span>
            </span>
          </div>
          <div class="info-row">
            <span class="info-label">Deskripsi:</span>
            <span class="info-value long-text">{{ konteksDetail.riskAppetiteDescription || '-' }}</span>
          </div>
        </div>

        <!-- Status & Count -->
        <div class="info-section">
          <div class="section-label">Status & Data</div>
          <div class="info-row">
            <span class="info-label">Status:</span>
            <span class="info-value">
              <span class="status-badge" [ngClass]="konteksDetail.isActive ? 'active' : 'inactive'">
                {{ konteksDetail.isActive ? 'Aktif' : 'Tidak Aktif' }}
              </span>
            </span>
          </div>
          <div class="info-row" *ngIf="konteksDetail._count">
            <span class="info-label">Risk Categories:</span>
            <span class="info-value">{{ konteksDetail._count.riskCategories || 0 }}</span>
          </div>
          <div class="info-row" *ngIf="konteksDetail._count">
            <span class="info-label">Risk Matrices:</span>
            <span class="info-value">{{ konteksDetail._count.riskMatrices || 0 }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- TABS -->
  <div class="card">
    <div class="tabs">
      <button class="tab" [class.active]="activeTab==='RISK_CATEGORY'" (click)="setTab('RISK_CATEGORY')">
        Risk Kategori
      </button>
      <button class="tab" [class.active]="activeTab==='RISK_IMPACT'" (click)="setTab('RISK_IMPACT')">
        Risk Impact
      </button>
      <button class="tab" [class.active]="activeTab==='LIKELIHOOD'" (click)="setTab('LIKELIHOOD')">
        Likelihood
      </button>
      <button class="tab" [class.active]="activeTab==='RISK_MATRIX'" (click)="setTab('RISK_MATRIX')">
        Risk Matrix
      </button>
    </div>

    <div class="card-body">
      <div *ngIf="loading" class="hint"><i class="fa-solid fa-spinner fa-spin"></i> Loading...</div>
      <div *ngIf="errorMsg" class="hint warn">{{ errorMsg }}</div>

      <!-- ===================== TAB: RISK CATEGORY ===================== -->
      <ng-container *ngIf="activeTab==='RISK_CATEGORY'">
        <div class="toolbar-like">
          <div class="toolbar-left">
            <div class="search-pill">
              <i class="fa-solid fa-magnifying-glass search-ico"></i>
              <input [(ngModel)]="qSearch" (keyup)="onSearchKeyup()" placeholder="Cari Kategori" />
            </div>
          </div>

          <div class="toolbar-right">
            <button class="btn primary" type="button" (click)="openCreateRC()">
              + Tambah Kategori
            </button>
          </div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>ORDER</th>
                <th>NAMA</th>
                <th>DESKRIPSI</th>
                <th class="th-actions">AKSI</th>
              </tr>
            </thead>

            <tbody>
              <tr *ngFor="let c of riskCategories">
                <td class="muted mono">{{ c.order }}</td>

                <td>
                  <div class="cell-stack">
                    <div class="primary">{{ c.name }}</div>
                    <div class="sub muted">ID: {{ c.id }}</div>
                  </div>
                </td>

                <td class="muted">{{ c.description || '-' }}</td>

                <td class="td-actions">
                  <button type="button" class="icon-btn" (click)="openEditRC(c)" title="Edit"><i class="fa-solid fa-pen-to-square"></i></button>
                  <button type="button" class="icon-btn danger" (click)="deleteRC(c)" title="Delete"><i class="fa-solid fa-trash"></i></button>
                </td>
              </tr>

              <tr *ngIf="!loading && riskCategories.length===0">
                <td colspan="4" class="empty">No risk categories found.</td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="pager" *ngIf="rcPagination">
          <div class="pager-left">
            Page {{ rcPagination.page }} / {{ rcPagination.totalPages }}
          </div>

          <div class="pager-right">
            <button class="pager-btn" type="button" (click)="rcPrev()" [disabled]="loading || !rcPagination.hasPrevPage">
              Prev
            </button>
            <button class="pager-btn" type="button" (click)="rcNext()" [disabled]="loading || !rcPagination.hasNextPage">
              Next
            </button>
          </div>
        </div>
      </ng-container>

      <!-- ===================== TAB: LIKELIHOOD ===================== -->
      <ng-container *ngIf="activeTab==='LIKELIHOOD'">
        <div class="toolbar-like">
          <div class="toolbar-left">
            <div class="select-pill wide">
              <select [(ngModel)]="selectedRiskCategoryId" (change)="onChangeCategoryForLikelihood()">
                <option *ngFor="let c of rawRiskCategories" [value]="c.id">{{ c.name }}</option>
              </select>
            </div>
            <small class="error" *ngIf="lkErrors.category">{{ lkErrors.category }}</small>
          </div>

          <div class="toolbar-right">
            <button class="btn primary" type="button" (click)="openCreateLK()" [disabled]="!selectedRiskCategoryId">
              + Tambah Likelihood
            </button>
          </div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>LEVEL</th>
                <th>LABEL</th>
                <th>DESKRIPSI</th>
                <th class="th-actions">AKSI</th>
              </tr>
            </thead>

            <tbody>
              <tr *ngFor="let l of likelihoods">
                <td class="muted mono">{{ l.level }}</td>

                <td>
                  <div class="cell-stack">
                    <div class="primary">{{ l.label }}</div>
                    <div class="sub muted">ID: {{ l.id }}</div>
                  </div>
                </td>

                <td class="muted">{{ l.description || '-' }}</td>

                <td class="td-actions">
                  <button type="button" class="icon-btn" (click)="openEditLK(l)" title="Edit"><i class="fa-solid fa-pen-to-square"></i></button>
                  <button type="button" class="icon-btn danger" (click)="deleteLK(l)" title="Delete"><i class="fa-solid fa-trash"></i></button>
                </td>
              </tr>

              <tr *ngIf="!loading && likelihoods.length===0">
                <td colspan="4" class="empty">
                  {{ lkEmptyHint || 'No likelihood scales found.' }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="pager" *ngIf="lkPagination && (likelihoods.length > 0 || (lkPagination.totalPages || 0) > 1)">
          <div class="pager-left">
            Page {{ lkPagination.page || 1 }} /
            {{ (lkPagination.totalPages && lkPagination.totalPages > 0) ? lkPagination.totalPages : 1 }}
          </div>

          <div class="pager-right">
            <button class="pager-btn" type="button" (click)="lkPrev()" [disabled]="loading || !lkPagination.hasPrevPage">
              Prev
            </button>
            <button class="pager-btn" type="button" (click)="lkNext()" [disabled]="loading || !lkPagination.hasNextPage">
              Next
            </button>
          </div>
        </div>
      </ng-container>

      <!-- placeholders -->
      <ng-container *ngIf="activeTab==='RISK_IMPACT'">
        <div class="toolbar-like">
          <div class="toolbar-left">
            <div class="select-pill wide">
              <select [(ngModel)]="selectedRiskCategoryId" (change)="onChangeCategoryForImpact()">
                <option *ngFor="let c of rawRiskCategories" [value]="c.id">{{ c.name }}</option>
              </select>
            </div>
            <small class="error" *ngIf="imErrors.category">{{ imErrors.category }}</small>
          </div>

          <div class="toolbar-right">
            <button class="btn primary" type="button" (click)="openCreateIM()" [disabled]="!selectedRiskCategoryId">
              + Tambah Impact
            </button>
          </div>
        </div>

        <div class="table-wrap">
          <table>
            <thead>
              <tr>
                <th>LEVEL</th>
                <th>LABEL</th>
                <th>DESKRIPSI</th>
                <th class="th-actions">AKSI</th>
              </tr>
            </thead>

            <tbody>
              <tr *ngFor="let i of impactScales">
                <td class="muted mono">{{ i.level }}</td>

                <td>
                  <div class="cell-stack">
                    <div class="primary">{{ i.label }}</div>
                    <div class="sub muted">ID: {{ i.id }}</div>
                  </div>
                </td>

                <td class="muted">{{ i.description || '-' }}</td>

                <td class="td-actions">
                  <button type="button" class="icon-btn" (click)="openEditIM(i)" title="Edit"><i class="fa-solid fa-pen-to-square"></i></button>
                  <button type="button" class="icon-btn danger" (click)="deleteIM(i)" title="Delete"><i class="fa-solid fa-trash"></i></button>
                </td>
              </tr>

              <tr *ngIf="!loading && impactScales.length===0">
                <td colspan="4" class="empty">
                  {{ imEmptyHint || 'No impact scales found.' }}
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <div class="pager" *ngIf="imPagination && (impactScales.length > 0 || (imPagination.totalPages || 0) > 1)">
          <div class="pager-left">
            Page {{ imPagination.page || 1 }} /
            {{ (imPagination.totalPages && imPagination.totalPages > 0) ? imPagination.totalPages : 1 }}
          </div>

          <div class="pager-right">
            <button class="pager-btn" type="button" (click)="imPrev()" [disabled]="loading || !imPagination.hasPrevPage">
              Prev
            </button>
            <button class="pager-btn" type="button" (click)="imNext()" [disabled]="loading || !imPagination.hasNextPage">
              Next
            </button>
          </div>
        </div>
      </ng-container>

      <ng-container *ngIf="activeTab==='RISK_MATRIX'">
        <div class="risk-matrix">
          <div class="matrix-header">
            <div class="matrix-title">Risk Matrix {{ getMatrixSize() }}x{{ getMatrixSize() }}</div>
            <div class="matrix-legend">
              <span class="legend-pill low"><i class="fa-solid fa-shield"></i> LOW</span>
              <span class="legend-pill medium"><i class="fa-solid fa-triangle-exclamation"></i> MEDIUM</span>
              <span class="legend-pill high"><i class="fa-solid fa-fire"></i> HIGH</span>
            </div>
          </div>

          <div class="matrix-grid">
            <div class="matrix-axis y-axis">Impact</div>

            <div class="matrix-body">
              <div class="matrix-row" *ngFor="let impact of getMatrixLevels().slice().reverse()">
                <div class="matrix-label">{{ impact }}</div>
                <div class="matrix-cells">
                  <div
                    class="matrix-cell"
                    *ngFor="let likelihood of getMatrixLevels()"
                    [class.low]="getRiskClass(getRiskScore(impact, likelihood))==='low'"
                    [class.medium]="getRiskClass(getRiskScore(impact, likelihood))==='medium'"
                    [class.high]="getRiskClass(getRiskScore(impact, likelihood))==='high'">
                    {{ getRiskScore(impact, likelihood) }}
                  </div>
                </div>
              </div>
            </div>

            <div class="matrix-axis x-axis">
              <span>Skor Likelihood</span>
              <div class="x-labels">
                <span *ngFor="let likelihood of getMatrixLevels()">{{ likelihood }}</span>
              </div>
            </div>
          </div>
        </div>
      </ng-container>
    </div>
  </div>
</div>

<app-confirm-modal
  [isOpen]="confirmOpen"
  [title]="confirmTitle"
  [message]="confirmMessage"
  [details]="confirmDetails"
  [confirmText]="confirmConfirmText"
  [cancelText]="'Batal'"
  [showCancel]="confirmShowCancel"
  [tone]="confirmTone"
  (confirm)="confirmActionProceed()"
  (cancel)="closeConfirmModal()"
></app-confirm-modal>

<!-- ===================== MODAL: RISK CATEGORY ===================== -->
<div class="modal-backdrop" *ngIf="showRCModal">
  <div class="modal">
    <div class="modal-head">
      <h3>{{ rcModalMode === 'CREATE' ? 'Tambah Kategori Risiko' : 'Ubah Kategori Risiko' }}</h3>
      <button type="button" class="icon-close" (click)="closeRCModal()"><i class="fa-solid fa-xmark"></i></button>
    </div>

    <div class="modal-body">
      <div class="grid-2">
        <div class="field">
          <label>Nama</label>
          <input [(ngModel)]="rcForm.name" placeholder="Nama kategori" />
          <small class="error" *ngIf="rcErrors.name">{{ rcErrors.name }}</small>
        </div>

        <div class="field">
          <label>Order</label>
          <input type="number" [(ngModel)]="rcForm.order" placeholder="1" />
          <small class="error" *ngIf="rcErrors.order">{{ rcErrors.order }}</small>
        </div>
      </div>

      <div class="field">
        <label>Deskripsi</label>
        <input [(ngModel)]="rcForm.description" placeholder="Deskripsi kategori" />
        <small class="error" *ngIf="rcErrors.description">{{ rcErrors.description }}</small>
      </div>


      <div class="modal-actions">
        <button type="button" class="btn secondary" (click)="closeRCModal()" [disabled]="loading">Batal</button>
        <button type="button" class="btn primary" (click)="saveRC()" [disabled]="loading">Simpan</button>
      </div>
    </div>
  </div>
</div>

<!-- ===================== MODAL: LIKELIHOOD ===================== -->
<div class="modal-backdrop" *ngIf="showLKModal">
  <div class="modal">
    <div class="modal-head">
      <h3>{{ lkModalMode === 'CREATE' ? 'Tambah Likelihood' : 'Ubah Likelihood' }}</h3>
      <button type="button" class="icon-close" (click)="closeLKModal()"><i class="fa-solid fa-xmark"></i></button>
    </div>

    <div class="modal-body">
      <div class="grid-2">
        <div class="field">
          <label>Level</label>
          <input type="number" [(ngModel)]="lkForm.level" placeholder="1" />
          <small class="error" *ngIf="lkErrors.level">{{ lkErrors.level }}</small>
        </div>

        <div class="field">
          <label>Label</label>
          <input [(ngModel)]="lkForm.label" placeholder="Sangat Jarang" />
          <small class="error" *ngIf="lkErrors.label">{{ lkErrors.label }}</small>
        </div>
      </div>

      <div class="field">
        <label>Deskripsi</label>
        <input [(ngModel)]="lkForm.description" placeholder="Deskripsi probabilitas" />
        <small class="error" *ngIf="lkErrors.description">{{ lkErrors.description }}</small>
      </div>


      <div class="modal-actions">
        <button type="button" class="btn secondary" (click)="closeLKModal()" [disabled]="loading">Batal</button>
        <button type="button" class="btn primary" (click)="saveLK()" [disabled]="loading">Simpan</button>
      </div>
    </div>
  </div>
</div>

<!-- ===================== MODAL: IMPACT ===================== -->
<div class="modal-backdrop" *ngIf="showIMModal">
  <div class="modal">
    <div class="modal-head">
      <h3>{{ imModalMode === 'CREATE' ? 'Tambah Impact' : 'Ubah Impact' }}</h3>
      <button type="button" class="icon-close" (click)="closeIMModal()"><i class="fa-solid fa-xmark"></i></button>
    </div>

    <div class="modal-body">
      <div class="grid-2">
        <div class="field">
          <label>Level</label>
          <input type="number" [(ngModel)]="imForm.level" placeholder="1" />
          <small class="error" *ngIf="imErrors.level">{{ imErrors.level }}</small>
        </div>

        <div class="field">
          <label>Label</label>
          <input [(ngModel)]="imForm.label" placeholder="Sangat Rendah" />
          <small class="error" *ngIf="imErrors.label">{{ imErrors.label }}</small>
        </div>
      </div>

      <div class="field">
        <label>Deskripsi</label>
        <input [(ngModel)]="imForm.description" placeholder="Deskripsi dampak" />
        <small class="error" *ngIf="imErrors.description">{{ imErrors.description }}</small>
      </div>


      <div class="modal-actions">
        <button type="button" class="btn secondary" (click)="closeIMModal()" [disabled]="loading">Batal</button>
        <button type="button" class="btn primary" (click)="saveIM()" [disabled]="loading">Simpan</button>
      </div>
    </div>
  </div>
</div>

<!-- ===================== MODAL: EDIT KONTEKS ===================== -->
<div class="modal-backdrop" *ngIf="showKonteksModal">
  <div class="modal">
    <div class="modal-head">
      <h3>Ubah Data Konteks</h3>
      <button type="button" class="icon-close" (click)="closeKonteksModal()"><i class="fa-solid fa-xmark"></i></button>
    </div>

    <div class="modal-body">
      <div class="field">
        <label>Nama</label>
        <input [(ngModel)]="konteksForm.name" placeholder="Konteks Risiko 2026" />
        <small class="error" *ngIf="konteksModalErrors.name">{{ konteksModalErrors.name }}</small>
      </div>

      <div class="field">
        <label>Deskripsi <span class="char-hint">(maks. 500 karakter)</span></label>
        <textarea [(ngModel)]="konteksForm.description" placeholder="Deskripsi konteks" rows="3" maxlength="500"></textarea>
        <small class="error" *ngIf="konteksModalErrors.description">{{ konteksModalErrors.description }}</small>
      </div>

      <div class="divider"></div>

      <div class="section-title">Risk Appetite</div>

      <div class="field">
        <label>Level</label>
        <select [(ngModel)]="konteksForm.riskAppetiteLevel">
          <option *ngFor="let a of appetiteOptions" [value]="a">{{ a }}</option>
        </select>
        <small class="error" *ngIf="konteksModalErrors.riskAppetiteLevel">{{ konteksModalErrors.riskAppetiteLevel }}</small>
      </div>

      <div class="field">
        <label>Deskripsi Risk Appetite <span class="char-hint">(maks. 500 karakter)</span></label>
        <textarea [(ngModel)]="konteksForm.riskAppetiteDescription" placeholder="Tingkat selera risiko..." rows="3" maxlength="500"></textarea>
        <small class="error" *ngIf="konteksModalErrors.riskAppetiteDescription">{{ konteksModalErrors.riskAppetiteDescription }}</small>
      </div>


      <div class="modal-actions">
        <button type="button" class="btn secondary" (click)="closeKonteksModal()" [disabled]="loading">Batal</button>
        <button type="button" class="btn primary" (click)="saveKonteks()" [disabled]="loading">Simpan</button>
      </div>
    </div>
  </div>
</div>
