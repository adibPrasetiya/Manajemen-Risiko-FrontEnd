<div class="session-page">
  <!-- Stats Cards - Outside filter container -->
  <div class="stats-row">
    <div class="stat-card">
      <div class="stat-icon">
        <i class="fa-solid fa-layer-group"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ totalSessions }}</div>
        <div class="stat-label">Total Sessions</div>
      </div>
    </div>

    <div class="stat-card stat-active">
      <div class="stat-icon">
        <i class="fa-solid fa-circle-check"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ totalActive }}</div>
        <div class="stat-label">Active Sessions</div>
      </div>
    </div>

    <div class="stat-card stat-inactive">
      <div class="stat-icon">
        <i class="fa-solid fa-clock"></i>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ totalExpired }}</div>
        <div class="stat-label">Expired Sessions</div>
      </div>
    </div>
  </div>

  <!-- Filters -->
  <div class="card">
    <div class="card-body">
      <div class="filters-primary">
        <div class="search-group">
          <div class="search-field">
            <i class="fa-solid fa-magnifying-glass search-icon"></i>
            <input
              [(ngModel)]="fUsername"
              placeholder="Search by username..."
              (keyup.enter)="applyFilters()"
            />
          </div>
          <div class="search-field">
            <i class="fa-solid fa-layer-group search-icon"></i>
            <select [(ngModel)]="fStatus">
              <option value="ALL">All Status</option>
              <option value="ACTIVE">Active</option>
              <option value="EXPIRED">Expired</option>
            </select>
          </div>
        </div>

        <div class="filter-actions">
          <button
            class="btn-advanced"
            type="button"
            (click)="toggleAdvancedFilters()"
            [class.active]="showAdvancedFilters"
          >
            <i class="fa-solid fa-sliders"></i>
            <span>Filters</span>
            <i class="fa-solid fa-chevron-down chevron" [class.rotate]="showAdvancedFilters"></i>
          </button>

          <button
            class="btn primary"
            type="button"
            (click)="applyFilters()"
            [disabled]="loading"
          >
            <i class="fa-solid fa-magnifying-glass"></i>
            Search
          </button>

          <button
            class="btn"
            type="button"
            (click)="resetFilters()"
            [disabled]="loading"
          >
            <i class="fa-solid fa-rotate-right"></i>
            Reset
          </button>

          <button
            class="btn danger"
            type="button"
            (click)="revokeAllExpired()"
            [disabled]="loading || revokeExpiredLoading"
            title="Hapus semua session expired"
          >
            <i class="fa-solid fa-trash-can"></i>
            {{ revokeExpiredLoading ? 'Revoking...' : 'Revoke all' }}
          </button>
        </div>
      </div>

      <div class="filters-advanced" *ngIf="showAdvancedFilters">
        <div class="advanced-divider"></div>
        <div class="advanced-grid">
          <div class="field">
            <label>Email</label>
            <input [(ngModel)]="fEmail" placeholder="Cari email..." />
          </div>

          <div class="field">
            <label>Created Dari</label>
            <input type="date" [(ngModel)]="fFrom" />
          </div>

          <div class="field">
            <label>Created Hingga</label>
            <input type="date" [(ngModel)]="fTo" />
          </div>
        </div>
      </div>

      <div *ngIf="loading" class="hint">
        <i class="fa-solid fa-spinner fa-spin"></i>
        Loading...
      </div>
      <div *ngIf="errorMsg" class="hint warn">{{ errorMsg }}</div>
      <div *ngIf="successMsg" class="hint ok">{{ successMsg }}</div>
    </div>
  </div>

  <!-- Table -->
  <div class="card">
    <div class="table-wrap">
      <table>
        <thead>
          <tr>
            <th>DEVICE</th>
            <th>USER</th>
            <th>IP ADDRESS</th>
            <th>STATUS</th>
            <th>CREATED</th>
            <th>EXPIRES</th>
            <th class="th-actions">ACTIONS</th>
          </tr>
        </thead>

        <tbody>
          <tr *ngFor="let s of filtered; trackBy: trackById">
            <!-- DEVICE -->
            <td>
              <div class="cell-stack">
                <div class="primary">{{ s.deviceName }}</div>
                <div class="sub muted mono">{{ shortDeviceId(s.deviceId) }}</div>
              </div>
            </td>

            <!-- USER -->
            <td>
              <div class="cell-stack">
                <div class="primary">{{ s.user?.name }}</div>
                <div class="sub muted">{{ s.user?.username }}</div>
                <div class="sub muted">{{ s.user?.email }}</div>
              </div>
            </td>

            <!-- IP -->
            <td class="mono">{{ s.ipAddress }}</td>

            <!-- STATUS -->
            <td>
              <span class="badge status" [ngClass]="getStatusClass(s)">
                {{ getStatusLabel(s) }}
              </span>
            </td>

            <!-- CREATED -->
            <td class="muted">
              <span class="dt">
                <span class="dt-ico"><i class="fa-solid fa-plus"></i></span>
                {{ s.createdAt | date:'d MMM y, HH.mm' }}
              </span>
            </td>

            <!-- EXPIRES -->
            <td class="muted">
              <span class="dt" [class.expired]="isExpired(s.expiresAt)">
                <span class="dt-ico" [class.expired]="isExpired(s.expiresAt)">
                  <i class="fa-solid fa-clock"></i>
                </span>
                {{ s.expiresAt | date:'d MMM y, HH.mm' }}
              </span>
            </td>

            <!-- ACTIONS -->
            <td class="td-actions">
              <button
                type="button"
                class="danger-btn"
                title="Revoke"
                (click)="revokeSession(s)"
                [disabled]="actionLoadingId === s.id"
              >
                <i class="fa-solid fa-trash-can" *ngIf="actionLoadingId !== s.id"></i>
                <i class="fa-solid fa-spinner fa-spin" *ngIf="actionLoadingId === s.id"></i>
              </button>
            </td>
          </tr>

          <tr *ngIf="!loading && filtered.length === 0">
            <td colspan="7" class="empty">No sessions found.</td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div class="pagination" *ngIf="pagination && pagination.totalPages > 0">
      <div class="pagination-info">
        <span class="showing-text">
          Showing <strong>{{ getShowingStart() }}</strong> - <strong>{{ getShowingEnd() }}</strong>
          of <strong>{{ pagination.totalItems || pagination.total }}</strong> sessions
        </span>
      </div>

      <div class="pagination-controls">
        <div class="per-page">
          <label>Rows:</label>
          <select [(ngModel)]="limit" (ngModelChange)="onLimitChange()">
            <option *ngFor="let opt of limitOptions" [value]="opt">{{ opt }}</option>
          </select>
        </div>

        <div class="page-nav">
          <button
            class="nav-btn"
            type="button"
            (click)="prevPage()"
            [disabled]="loading || !pagination.hasPrevPage"
            title="Previous page"
          >
            <i class="fa-solid fa-chevron-left"></i>
          </button>

          <div class="page-numbers">
            <ng-container *ngFor="let p of getPageNumbers()">
              <span class="ellipsis" *ngIf="p === -1">...</span>
              <button
                *ngIf="p !== -1"
                class="page-btn"
                type="button"
                [class.active]="p === pagination.page"
                (click)="goToPage(p)"
                [disabled]="loading"
              >
                {{ p }}
              </button>
            </ng-container>
          </div>

          <button
            class="nav-btn"
            type="button"
            (click)="nextPage()"
            [disabled]="loading || !pagination.hasNextPage"
            title="Next page"
          >
            <i class="fa-solid fa-chevron-right"></i>
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<app-confirm-modal
  [isOpen]="confirmOpen"
  [title]="confirmTitle"
  [message]="confirmMessage"
  [details]="confirmDetails"
  [confirmText]="confirmConfirmText"
  [cancelText]="'Batal'"
  [showCancel]="true"
  [tone]="'danger'"
  (confirm)="confirmActionProceed()"
  (cancel)="closeConfirm()"
></app-confirm-modal>
